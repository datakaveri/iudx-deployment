worker_processes auto;

events {
  worker_connections 1024;
}

http {
    resolver 127.0.0.11 valid=5s;

    limit_req_status 429;

    limit_conn_zone $server_name zone=rs_conn_total:10m;
    limit_conn_zone $binary_remote_addr zone=rs_conn_per_ip:10m;

    limit_conn rs_conn_total 2000;
    limit_conn rs_conn_per_ip 150;
        
    limit_req_zone $server_name zone=rs_req_total:10m rate=1000r/s;
    limit_req_zone $binary_remote_addr zone=rs_req_per_ip:10m rate=100r/s;

    limit_req zone=rs_req_total burst=400;
    limit_req zone=rs_req_per_ip burst=150;

    ssl_certificate     /etc/ssl/rs-cert;
    ssl_certificate_key /etc/ssl/rs-key;
    ssl_protocols       TLSv1.2 TLSv1.3;
    ssl_ciphers         HIGH:!aNULL:!MD5;
    ssl_session_timeout 3h;
    ssl_session_cache shared:rsSSL:20m;  # About 80000 sessions
    ssl_session_tickets off;
    server_tokens off; # Hiding the nginx version 
 # default server block ( Deny access from any other domain name/ip )
    server {
        listen 443 ssl default_server;
        server_name _;
        return 444;
      }

    # Main block
    server {
        listen              443 ssl;
        server_name         ${API_SERVER_NAME};            
        location / {
            set $backend_servers ${API_SERVICE_NAME};
            # compression is supported in HTTP >=1.1
            proxy_http_version 1.1;
            proxy_pass ${API_SERVER_PROTOCOL}://$backend_servers:${API_SERVICE_PORT};
        }
    }

    #error codes
    server{
      error_page 500 /500.json;
      location /500.json {
          return 500 '{"error":{"code":500,"message":"Internal Server Error"}}';
      }

      error_page 502 /502.json;
      location /502.json {
          return 502 '{"error":{"code":502,"message":"Bad Gateway"}}';
      }
      
      error_page 503 /503.json;
      location /503.json {
          return 503 '{"error":{"code":503,"message":"Service Temporarily Unavailable"}}';
      }
      
      error_page 504 /504.json;
      location /504.json {
          return 504 '{"error":{"code":504,"message":"Gateway Timeout"}}';
      }
      
      error_page 400 /400.json;
      location /400.json {
          return 400 '{"error":{"code":400,"message":"Bad Request"}}';
      }
      
      error_page 401 /401.json;
      location /401.json {
          return 401 '{"error":{"code":401,"message":"Unauthorized"}}';
      }
      
      error_page 403 /403.json;
      location /403.json {
          return 403 '{"error":{"code":403,"message": "Forbidden"}}';
      }
      
      error_page 404 /404.json;
      location /404.json {
          return 404 '{"error":{"code":404,"message":"Not Found"}}';
      }
      
      error_page 408 /408.json;
      location /408.json {
          return 408 '{"error":{"code":408,"message":"Request Timeout"}}';
      }

      error_page 414 /414.json;
      location /414.json{
          return 414 '{"error":{"code":414,"message":"URI too long"}}'

      }
    }
}
