worker_processes auto;

events {
  worker_connections 1024;
}

http {
    resolver 127.0.0.11 valid=5s;

    limit_req_status 429;

    # define rate and connection limiting for keycloak
    limit_conn_zone $server_name zone=keycloak_conn_total:10m;
    limit_conn_zone $binary_remote_addr zone=keycloak_conn_per_ip:10m;
    limit_req_zone $server_name zone=keycloak_req_total:10m rate=1000r/s;
    limit_req_zone $binary_remote_addr zone=keycloak_req_per_ip:10m rate=100r/s;

    # defile rate and connections limiting for file-server
    limit_conn_zone $server_name zone=fs_conn_total:10m;
    limit_conn_zone $binary_remote_addr zone=fs_conn_per_ip:10m;
    limit_req_zone $server_name zone=fs_req_total:10m rate=1000r/s;
    limit_req_zone $binary_remote_addr zone=fs_req_per_ip:10m rate=100r/s;

    # defile rate and connections limiting for resource-server
    limit_conn_zone $server_name zone=rs_conn_total:10m;
    limit_conn_zone $binary_remote_addr zone=rs_conn_per_ip:10m;
    limit_req_zone $server_name zone=rs_req_total:10m rate=1000r/s;
    limit_req_zone $binary_remote_addr zone=rs_req_per_ip:10m rate=100r/s;


    # defile rate and connections limiting for auth-server
    limit_conn_zone $server_name zone=auth_conn_total:10m;
    limit_conn_zone $binary_remote_addr zone=auth_conn_per_ip:10m;
    limit_req_zone $server_name zone=auth_req_total:10m rate=1000r/s;
    limit_req_zone $binary_remote_addr zone=auth_req_per_ip:10m rate=100r/s;


    # define rate and connections limiting for catalogue server.
     limit_conn_zone $server_name zone=cat_conn_total:10m;
     limit_conn_zone $binary_remote_addr zone=cat_conn_per_ip:10m;
     limit_req_zone $server_name zone=cat_req_total:10m rate=1000r/s;
     limit_req_zone $binary_remote_addr zone=cat_req_per_ip:10m rate=100r/s;





 	##
	# Virtual Host Configs
	##

	include /etc/nginx/conf.d/*.conf;
}
