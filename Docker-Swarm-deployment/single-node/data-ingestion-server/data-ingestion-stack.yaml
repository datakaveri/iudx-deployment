version: '3.9'

services:
        data-ingestion:
                image: iudx/di-depl:latest
                command:  bash -c "exec java $$RS_JAVA_OPTS  -Dvertx.logger-delegate-factory-class-name=io.vertx.core.logging.Log4j2LogDelegateFactory -jar ./fatjar.jar  --host $$(hostname) -c configs/config.json"
                cap-drop:
                        - ALL
                read_only: true
                volumes:
                        - type: tmpfs
                          target: /tmp/
                          read-only: false
                environment:
                        - ./.data-ingestion.env
                logging:
                        driver: "json-file"
                        options:
                                max-file: "5"
                                max-size: "100m"
                                tag: "{\"name\":\"{{.Name}}\",\"id\":\"{{.ID}}\"}"
                secrets:
                        - source: keystore
                          target: /usr/share/app/secrets/keystore.jks
                        - source: config
                          target: /usr/share/app/secrets/configs/config.json                 
                networks:
                       - overlay-net
                deploy:
                        replicas: 1
                        restart_policy:
                                condition: any
                                 max_attempts: 5
                        placement:
                                 constraints:
                                         - "node.labels.data-ingestion-node==true"         
networks:
        overlay-net:
                external: true
                driver: overlay

secrets:
        keystore:
                file: ./secrets/keystore.jks
        config:
                file: ./secrets/configs/config-depl.json 




