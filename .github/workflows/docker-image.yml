name: Docker Image CI

on:
  registry_package:
    types: [published]

jobs:

  build:
    runs-on: self-hosted

    steps:
    - uses: actions/checkout@v3
    - name: Build the docker image
      run: |
        git config --global user.name 'tharak1242'
        git config --global user.password ${{ secrets.PAT }}
        git fetch
        git checkout docker-tag
        export tag=`(head -n1 <(curl -H "Accept: application/vnd.github+json" -H "Authorization: Bearer ${{ secrets.PAT }}" https://api.github.com/orgs/datakaveri/packages/container/rs-depl/versions | jq ' .[].metadata.container.tags[0]' ) | grep 4.5.0-alpha)`
        export newtag="ghcr.io/datakaveri/rs-depl:$tag"
        export oldtag=`yq -r .services.rs.image rs-stack.yaml`
        sed -i "s/$oldtag/$newtag/g" rs-stack.yaml
        git add rs-stack.yaml
        git commit -m "Updated rs image tag"
        git push --set-upstream origin docker-tag

