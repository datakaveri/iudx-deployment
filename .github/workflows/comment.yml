name: Test Resource Server

on:
  pull_request_target:
    types: [opened, reopened, synchronize]
  #issue_comment:
   # types: [created]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Debug info
      run: |
        echo "Clone URL: ${{ github.event.pull_request.head.repo.clone_url }}"
        echo "Branch name: ${{ github.event.pull_request.head.ref }}"
        echo "repository: ${{ github.event.pull_request.head.repo.owner.login }}/${{ github.event.pull_request.head.repo.name }}"
        echo "${{ secrets.RESOURCE_VALUES }}" > RESOURCE_VALUES.yaml
        cat RESOURCE_VALUES.yaml
        
    - name: Dump context
      run: echo '${{ toJSON(github.event) }}' | jq
      shell: bash
      
    - name: Checkout PR code
      uses: actions/checkout@v3
      with:
        repository: ${{ github.event.pull_request.head.repo.owner.login }}/${{ github.event.pull_request.head.repo.name }}
        ref: ${{ github.event.pull_request.head.ref }}       
        
    - name: List Files
      run: |
          pwd
          ls -a
          ls .github/workflows
          git branch
          echo $GITHUB_REPOSITORY
          echo $GITHUB_WORKSPACE
          env
    
      
    - name: Install kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.24.8'
        kubeconfig: ${{ secrets.KUBE_CONFIG }}
      id: install
      
    - name: Install Helm
      uses: azure/setup-helm@v3
      with:
         token: ${{ github.token }}

    ##- name: Download Testkube CLI
    ##   run: curl -sL https://testkube.com/install | sh -
      
   ## - name: testkube
   ##   uses: kubeshop/testkube-docker-action@v1


    - name: configure resource server and deploy
      run: |
        cp -r K8s-deployment/Charts/resource-server/example-secrets/* K8s-deployment/Charts/resource-server/
        echo "${{ secrets.RS_RESOURCE_VALUES}}" > K8s-deployment/Charts/resource-server/resource-values.yaml
        echo -n "${{ secrets.AWS_SECRET_ACCESS_KEY }}"  > K8s-deployment/Charts/resource-server/secrets/AWS_SECRET_ACCESS_KEY
        echo -n "${{ secrets.AWS_ACCESS_KEY_ID }}" > K8s-deployment/Charts/resource-server/secrets/AWS_ACCESS_KEY_ID
        echo "${{ secrets.RS_CONFIG }}" > K8s-deployment/Charts/resource-server/secrets/config.json
        kubectl create configmap rs-env --from-env-file=./secrets/.rs.env -n test
        kubectl create secret generic rs-s3-env --from-file=./secrets/AWS_ACCESS_KEY_ID --from-file=./secrets/AWS_SECRET_ACCESS_KEY -n test
        kubectl create secret generic rs-config --from-file=./secrets/config.json -n rs
        helm install resource-server ../resource-server -f values.yaml -f resource-values.yaml $@ -n test
