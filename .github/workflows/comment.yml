name: Test Resource Server

on:
  pull_request_target:
    types: [opened, reopened, synchronize]
  #issue_comment:
   # types: [created]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:        
    - name: Dump context
      run: echo '${{ toJSON(github.event) }}' | jq
      shell: bash
      
    - name: Checkout PR code
      uses: actions/checkout@v3
      with:
        repository: ${{ github.event.pull_request.head.repo.owner.login }}/${{ github.event.pull_request.head.repo.name }}
        ref: ${{ github.event.pull_request.head.ref }}       
        
    - name: List Files
      run: |
          pwd
          ls -a
          ls .github/workflows
          git branch
          echo $GITHUB_REPOSITORY
          echo $GITHUB_WORKSPACE
          env
    
      
    - name: Install kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.24.8'
      id: install
      
    - name: Configure kubectl
      run: |
        mkdir -p $HOME/.kube
        echo "${{ secrets.KUBE_CONFIG }}" | base64 --decode > $HOME/.kube/config
          
    - name: Inspect kubectl config
      run: kubectl config view 
     
    - name: Check kubectl
      run: |
        kubectl get node
        
      
    - name: Install Helm
      uses: azure/setup-helm@v3
      with:
         token: ${{ github.token }}
    - name: Check helm
      run: |
        helm list -n zookeeper

    ##- name: Download Testkube CLI
    ##   run: curl -sL https://testkube.com/install | sh -
      
   ## - name: testkube
   ##   uses: kubeshop/testkube-docker-action@v1


    - name: configure resource server
      run: |
        cp -r K8s-deployment/Charts/resource-server/example-secrets/* K8s-deployment/Charts/resource-server/
        echo "${{ secrets.RS_RESOURCE_VALUES }}" > K8s-deployment/Charts/resource-server/resource-values.yaml
        echo -n "${{ secrets.AWS_SECRET_ACCESS_KEY }}"  > K8s-deployment/Charts/resource-server/secrets/AWS_SECRET_ACCESS_KEY
        echo -n "${{ secrets.AWS_ACCESS_KEY_ID }}" > K8s-deployment/Charts/resource-server/secrets/AWS_ACCESS_KEY_ID
        echo "${{ secrets.RS_CONFIG }}" | base64 --decode > K8s-deployment/Charts/resource-server/secrets/config.json
        
    - name: deploy
      run: |
        cd K8s-deployment/Charts/resource-server/
        kubectl create configmap rs-env --from-env-file=./secrets/.rs.env -n test
        kubectl create secret generic rs-s3-env --from-file=./secrets/AWS_ACCESS_KEY_ID --from-file=./secrets/AWS_SECRET_ACCESS_KEY -n test
        kubectl create secret generic rs-config --from-file=./secrets/config.json -n test
        helm install resource-server "../resource-server" -f values.yaml -f resource-values.yaml -n test
